<!DOCTYPE html>
<html>
<head>
    <title>MilestoneKanbanBurnDown</title>

    <script type="text/javascript" src="/apps/2.0/sdk.js"></script>

    <script type="text/javascript">
        Rally.onReady(function () {
                Ext.define("Calculator",{extend:"Rally.data.lookback.calculator.TimeSeriesCalculator",config:{stateFieldName:"c_KanbanState",doneStateFieldValues:["Accepted"]},constructor:function(config){this.initConfig(config),this.callParent(arguments)},getDerivedFieldsOnInput:function(){var completedValues=this.getDoneStateFieldValues();return[{as:"Planned",f:function(snapshot){return snapshot.PlanEstimate?snapshot.PlanEstimate:0}},{as:"Completed",f:function(snapshot){return _.contains(completedValues,snapshot.c_KanbanState)&&snapshot.PlanEstimate?snapshot.PlanEstimate:0}}]},getMetrics:function(){return[{field:"Planned",as:"Planned",display:"line",f:"sum"},{field:"Completed",as:"Completed",f:"sum",display:"column"}]}});
                Ext.define("Rally.data.lookback.SnapshotRestProxyOverride",{override:"Rally.data.lookback.SnapshotRestProxy",timeout:3e5}),Ext.define("CustomApp",{extend:"Rally.app.App",componentCls:"app",launch:function(){this.add({xtype:"rallymilestonecombobox",width:200,height:22,context:this.getContext(),listeners:{ready:this._milestoneAvailable,select:this._milestoneSelected,scope:this}})},_milestoneAvailable:function(){Ext.create("Rally.data.wsapi.Store",{model:"TypeDefinition",fetch:["TypePath"],filters:[{property:"Parent.Name",value:"Portfolio Item"},{property:"Ordinal",value:0}]}).load().then({success:function(records){this.piType=records[0].get("TypePath"),this._milestoneSelected()},scope:this})},_milestoneSelected:function(){Ext.create("Rally.data.wsapi.Store",{model:this.piType,fetch:["ObjectID","Project","Name","PreliminaryEstimate","ActualStartDate","PlannedEndDate"],filters:[{property:"Milestones",operator:"contains",value:this.down("rallymilestonecombobox").getValue()}],context:{project:null},limit:1/0}).load().then({success:function(piRecords){this.piRecords=piRecords,this._showChart()},scope:this})},_showChart:function(){this.down("rallychart")&&this.down("rallychart").destroy(),this.add({xtype:"rallychart",storeType:"Rally.data.lookback.SnapshotStore",storeConfig:this._getStoreConfig(),calculatorType:"Calculator",calculatorConfig:{stateFieldName:"c_KanbanState",doneStateFieldValues:["Accepted"]},chartConfig:this._getChartConfig()})},_getChartConfig:function(){return{chart:{defaultSeriesType:"area",zoomType:"xy"},title:{text:"PI Burnup"},xAxis:{categories:[],tickmarkPlacement:"on",tickInterval:5,title:{text:"Date",margin:10}},yAxis:[{title:{text:"Points"}}],tooltip:{formatter:function(){return""+this.x+"<br />"+this.series.name+": "+this.y}},plotOptions:{series:{marker:{enabled:!1,states:{hover:{enabled:!0}}},groupPadding:.01},column:{stacking:null,shadow:!1}}}},_getStoreConfig:function(){return{find:{_TypeHierarchy:{$in:["HierarchicalRequirement","Defect"]},_ItemHierarchy:{$in:_.invoke(this.piRecords,"getId")},Children:null,_ProjectHierarchy:this.getContext().getProject().ObjectID},fetch:["c_KanbanState","PlanEstimate"],sort:{_ValidFrom:1},context:this.getContext().getDataContext(),limit:1/0}}});

            Rally.launchApp('CustomApp', {
                name:"MilestoneKanbanBurnDown",
	            parentRepos:""
            });

        });
    </script>


    <style type="text/css">
        
    </style>
</head>
<body>
</body>
</html>
